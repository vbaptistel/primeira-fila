generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EventDayStatus {
  ACTIVE
  CANCELLED
}

enum SessionStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum SessionSeatStatus {
  AVAILABLE
  HELD
  SOLD
  BLOCKED
}

enum SessionHoldStatus {
  ACTIVE
  EXPIRED
  CONSUMED
  CANCELLED
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  DENIED
  REFUNDED
  ERROR
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  DENIED
}

enum AuditAction {
  CHECK_IN
  REFUND_REQUESTED
  REFUND_APPROVED
  REFUND_DENIED
}

enum EmailStatus {
  SENT
  FAILED
  PENDING
}

enum CustomDomainStatus {
  PENDING_VERIFICATION
  VERIFIED
  FAILED
  REMOVED
}

model Tenant {
  id                     String              @id @db.Uuid
  name                   String              @db.VarChar(160)
  slug                   String              @unique @db.VarChar(80)
  subdomain              String              @unique @db.VarChar(63)
  logoUrl                String?             @map("logo_url") @db.VarChar(500)
  faviconUrl             String?             @map("favicon_url") @db.VarChar(500)
  primaryColor           String              @default("#000000") @map("primary_color") @db.VarChar(9)
  secondaryColor         String              @default("#FFFFFF") @map("secondary_color") @db.VarChar(9)
  accentColor            String              @default("#3B82F6") @map("accent_color") @db.VarChar(9)
  footerText             String?             @map("footer_text") @db.VarChar(500)
  termsUrl               String?             @map("terms_url") @db.VarChar(500)
  privacyUrl             String?             @map("privacy_url") @db.VarChar(500)
  socialLinks            Json?               @map("social_links")
  isActive               Boolean             @default(true) @map("is_active")
  customDomain           String?             @unique @map("custom_domain") @db.VarChar(255)
  customDomainStatus     CustomDomainStatus? @map("custom_domain_status")
  customDomainVerifiedAt DateTime?           @map("custom_domain_verified_at") @db.Timestamptz(6)
  createdAt              DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  commercialPolicies CommercialPolicy[]
  events             Event[]
  eventDays          EventDay[]
  sessions           Session[]
  sessionSeats       SessionSeat[]
  sessionHolds       SessionHold[]
  orders             Order[]
  payments           Payment[]
  tickets            Ticket[]
  refunds            Refund[]
  auditLogs          AuditLog[]
  emailLogs          EmailLog[]

  @@map("tenants")
}

model CommercialPolicy {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  tenant              Tenant   @relation(fields: [tenantId], references: [id])
  version             String   @db.VarChar(80)
  isPlatformDefault   Boolean  @default(false) @map("is_platform_default")
  serviceFeePercentBps Int     @map("service_fee_percent_bps")
  serviceFeeFixedCents Int     @map("service_fee_fixed_cents")
  currencyCode        String   @default("BRL") @map("currency_code") @db.VarChar(3)
  timezone            String   @default("America/Sao_Paulo") @db.VarChar(64)
  effectiveFrom       DateTime @map("effective_from") @db.Timestamptz(6)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, version])
  @@index([tenantId, effectiveFrom])
  @@map("commercial_policies")
}

model Event {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @map("tenant_id") @db.Uuid
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  name        String      @db.VarChar(160)
  slug        String      @db.VarChar(180)
  description String?     @db.Text
  timezone    String      @default("America/Sao_Paulo") @db.VarChar(64)
  status      EventStatus @default(DRAFT)
  eventDays   EventDay[]
  sessions    Session[]
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@map("events")
}

model EventDay {
  id        String         @id @default(uuid()) @db.Uuid
  tenantId  String         @map("tenant_id") @db.Uuid
  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  eventId   String         @map("event_id") @db.Uuid
  date      DateTime       @db.Date
  status    EventDayStatus @default(ACTIVE)
  event     Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sessions  Session[]
  createdAt DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([eventId, date])
  @@unique([id, eventId])
  @@index([tenantId, eventId])
  @@map("event_days")
}

model Session {
  id            String        @id @default(uuid()) @db.Uuid
  tenantId      String        @map("tenant_id") @db.Uuid
  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  eventId       String        @map("event_id") @db.Uuid
  eventDayId    String        @map("event_day_id") @db.Uuid
  name          String        @db.VarChar(160)
  startsAt      DateTime      @map("starts_at") @db.Timestamptz(6)
  endsAt        DateTime      @map("ends_at") @db.Timestamptz(6)
  salesStartsAt DateTime?     @map("sales_starts_at") @db.Timestamptz(6)
  salesEndsAt   DateTime?     @map("sales_ends_at") @db.Timestamptz(6)
  priceCents    Int           @map("price_cents")
  currencyCode  String        @default("BRL") @map("currency_code") @db.VarChar(3)
  capacity      Int
  status        SessionStatus @default(DRAFT)
  event         Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventDay      EventDay      @relation(fields: [eventDayId, eventId], references: [id, eventId], onDelete: Cascade)
  holds         SessionHold[]
  orders        Order[]
  orderItems    OrderItem[]
  tickets       Ticket[]
  sessionSeats  SessionSeat[]
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([eventDayId, startsAt])
  @@index([tenantId, status])
  @@index([eventId, eventDayId])
  @@map("sessions")
}

model SessionSeat {
  id         String            @id @default(uuid()) @db.Uuid
  tenantId   String            @map("tenant_id") @db.Uuid
  tenant     Tenant            @relation(fields: [tenantId], references: [id])
  sessionId  String            @map("session_id") @db.Uuid
  sectorCode String            @map("sector_code") @db.VarChar(32)
  rowLabel   String            @map("row_label") @db.VarChar(16)
  seatNumber Int               @map("seat_number")
  status     SessionSeatStatus @default(AVAILABLE)
  session    Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  holdSeats  SessionHoldSeat[]
  orderItems OrderItem[]
  tickets    Ticket[]
  createdAt  DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sessionId, sectorCode, rowLabel, seatNumber])
  @@index([tenantId, sessionId, status])
  @@map("session_seats")
}

model SessionHold {
  id          String            @id @default(uuid()) @db.Uuid
  tenantId    String            @map("tenant_id") @db.Uuid
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  sessionId   String            @map("session_id") @db.Uuid
  status      SessionHoldStatus @default(ACTIVE)
  expiresAt   DateTime          @map("expires_at") @db.Timestamptz(6)
  session     Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  heldSeats   SessionHoldSeat[]
  order       Order?
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, sessionId, status, expiresAt])
  @@map("session_holds")
}

model SessionHoldSeat {
  id         String      @id @default(uuid()) @db.Uuid
  holdId     String      @map("hold_id") @db.Uuid
  seatId     String      @map("seat_id") @db.Uuid
  hold       SessionHold @relation(fields: [holdId], references: [id], onDelete: Cascade)
  seat       SessionSeat @relation(fields: [seatId], references: [id], onDelete: Cascade)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([holdId, seatId])
  @@index([seatId])
  @@map("session_hold_seats")
}

model Order {
  id                      String      @id @default(uuid()) @db.Uuid
  tenantId                String      @map("tenant_id") @db.Uuid
  tenant                  Tenant      @relation(fields: [tenantId], references: [id])
  sessionId               String      @map("session_id") @db.Uuid
  holdId                  String      @unique @map("hold_id") @db.Uuid
  idempotencyKey          String      @unique @map("idempotency_key") @db.VarChar(64)
  requestHash             String      @map("request_hash") @db.VarChar(64)
  status                  OrderStatus @default(PENDING_PAYMENT)
  buyerName               String      @map("buyer_name") @db.VarChar(160)
  buyerEmail              String      @map("buyer_email") @db.VarChar(180)
  buyerDocument           String?     @map("buyer_document") @db.VarChar(32)
  currencyCode            String      @default("BRL") @map("currency_code") @db.VarChar(3)
  ticketSubtotalCents     Int         @map("ticket_subtotal_cents")
  serviceFeeCents         Int         @map("service_fee_cents")
  totalAmountCents        Int         @map("total_amount_cents")
  commercialPolicyVersion String      @default("platform_default_v1") @map("commercial_policy_version") @db.VarChar(80)
  holdExpiresAt           DateTime    @map("hold_expires_at") @db.Timestamptz(6)
  session                 Session     @relation(fields: [sessionId], references: [id], onDelete: Restrict)
  hold                    SessionHold @relation(fields: [holdId], references: [id], onDelete: Restrict)
  payments                Payment[]
  items                   OrderItem[]
  tickets                 Ticket[]
  refunds                 Refund[]
  createdAt               DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, status])
  @@index([sessionId, status])
  @@map("orders")
}

model Payment {
  id                String        @id @default(uuid()) @db.Uuid
  tenantId          String        @map("tenant_id") @db.Uuid
  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  orderId           String        @map("order_id") @db.Uuid
  idempotencyKey    String        @unique @map("idempotency_key") @db.VarChar(64)
  requestHash       String        @map("request_hash") @db.VarChar(64)
  provider          String        @default("mock_gateway") @db.VarChar(40)
  providerPaymentId String        @unique @map("provider_payment_id") @db.VarChar(80)
  method            PaymentMethod
  status            PaymentStatus @default(PENDING)
  amountCents       Int           @map("amount_cents")
  currencyCode      String        @map("currency_code") @db.VarChar(3)
  providerPayload   Json?         @map("provider_payload")
  approvedAt        DateTime?     @map("approved_at") @db.Timestamptz(6)
  deniedAt          DateTime?     @map("denied_at") @db.Timestamptz(6)
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds           Refund[]
  createdAt         DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, orderId, status])
  @@index([orderId, status])
  @@map("payments")
}

model OrderItem {
  id             String   @id @default(uuid()) @db.Uuid
  orderId        String   @map("order_id") @db.Uuid
  sessionId      String   @map("session_id") @db.Uuid
  seatId         String   @map("seat_id") @db.Uuid
  unitPriceCents Int      @map("unit_price_cents")
  currencyCode   String   @map("currency_code") @db.VarChar(3)
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Restrict)
  seat           SessionSeat @relation(fields: [seatId], references: [id], onDelete: Restrict)
  ticket         Ticket?
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([orderId, seatId])
  @@index([sessionId, seatId])
  @@map("order_items")
}

model Ticket {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  orderId     String       @map("order_id") @db.Uuid
  orderItemId String       @unique @map("order_item_id") @db.Uuid
  sessionId   String       @map("session_id") @db.Uuid
  seatId      String       @map("seat_id") @db.Uuid
  qrCode      String       @unique @map("qr_code") @db.VarChar(64)
  status      TicketStatus @default(VALID)
  usedAt      DateTime?    @map("used_at") @db.Timestamptz(6)
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem   OrderItem    @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  session     Session      @relation(fields: [sessionId], references: [id], onDelete: Restrict)
  seat        SessionSeat  @relation(fields: [seatId], references: [id], onDelete: Restrict)
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, orderId])
  @@index([orderId, status])
  @@map("tickets")
}

model Refund {
  id                 String       @id @default(uuid()) @db.Uuid
  tenantId           String       @map("tenant_id") @db.Uuid
  tenant             Tenant       @relation(fields: [tenantId], references: [id])
  orderId            String       @map("order_id") @db.Uuid
  paymentId          String       @map("payment_id") @db.Uuid
  reasonCode         String       @map("reason_code") @db.VarChar(60)
  reasonDescription  String?      @map("reason_description") @db.VarChar(500)
  amountCents        Int          @map("amount_cents")
  status             RefundStatus @default(REQUESTED)
  requestedBy        String       @map("requested_by") @db.Uuid
  processedAt        DateTime?    @map("processed_at") @db.Timestamptz(6)
  order              Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payment            Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  createdAt          DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([tenantId, orderId])
  @@index([orderId, status])
  @@map("refunds")
}

model AuditLog {
  id           String      @id @default(uuid()) @db.Uuid
  tenantId     String      @map("tenant_id") @db.Uuid
  tenant       Tenant      @relation(fields: [tenantId], references: [id])
  actorId      String      @map("actor_id") @db.Uuid
  action       AuditAction
  resourceType String      @map("resource_type") @db.VarChar(60)
  resourceId   String      @map("resource_id") @db.Uuid
  metadata     Json?
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId, action])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

model EmailLog {
  id               String      @id @default(uuid()) @db.Uuid
  tenantId         String      @map("tenant_id") @db.Uuid
  tenant           Tenant      @relation(fields: [tenantId], references: [id])
  orderId          String?     @map("order_id") @db.Uuid
  to               String      @db.VarChar(180)
  subject          String      @db.VarChar(255)
  templateName     String      @map("template_name") @db.VarChar(80)
  status           EmailStatus @default(PENDING)
  errorMessage     String?     @map("error_message") @db.VarChar(500)
  resendMessageId  String?     @map("resend_message_id") @db.VarChar(80)
  sentAt           DateTime?   @map("sent_at") @db.Timestamptz(6)
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([tenantId, status])
  @@index([orderId])
  @@map("email_logs")
}
